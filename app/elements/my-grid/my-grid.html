<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<dom-module id="my-grid">
  <template>
    <style>
      #loadingIndicatorRow .hide {
        display: none;
      }
      #loadingIndicatorRow .show {
        display: block;
      }

      /* Anim */
      @keyframes grid-spin-360 {
        100% {
          transform: rotate(360deg);
        }
      }

      @-webkit-keyframes grid-spin-360 {
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }

      #grid-container.grid-loading-data vaadin-grid:after {
        -webkit-animation: grid-spin-360 400ms linear infinite;
        animation: grid-spin-360 400ms linear infinite;
        border: 2px solid #03A9F4;
        border-radius: 50%;
        border-right-color: transparent;
        border-top-color: transparent;
        content: "";
        display: block;
        height: 16px;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        position: absolute;
        top: 70%;
        width: 16px;
        z-index: 9;
      }
/*
      #grid-container {
        overflow: auto;
        @apply(--layout-relative);
      }

      #grid {
        @apply(--layout-relative);
      }
*/
      #columnState {
        position: fixed;
        top: 260px;
        right: 16px;
        background-color: var(--primary-background-color);
      }

      div.innerDiv{
        white-space:nowrap;
      }

      div.columns{
        overflow:hidden;
        //overflow-x: scroll;
        width: 90vw;
      }

      div.rows{
        overflow: scroll;
        height:   43px;
        width:    90vw;
      }

      div.data{
        overflow:scroll;
        height:60px;
        width: 95vw;
      }

      table {
        border-collapse: collapse;
        //height: 100vh;
        @apply(--paper-font-body1);

        table-layout:fixed;
        border-color: var(--primary-text-color);
        border: 0;
      //	border-collapse:collapse;
      }

      table tr th {
        padding: 8px;
        color: var(--primary-text-color);
        border-bottom: 2px solid var(--divider-color);
        display: table-cell;
        vertical-align: top;
      }

      table td {
        padding: 8px;
        color: var(--primary-text-color);
        border-width:0px;
        border-style:hidden;
        vertical-align:top;
        border-collapse:collapse;
        display: table-cell;
        vertical-align: top;
      }

      table.inner {
        border-width:0px;
        border-style:hidden;
      }

      table.inner td {
        padding: 0px;
        display: table-cell;
        vertical-align: top;
      }
    </style>
    <iron-media-query full query="print" query-matches="{{print}}"></iron-media-query>
    <div id="grid-container">
      <div id="grid">
        <table class="">
          <colgroup>
            <col >
            <col >
          </colgroup>
          <tbody>
            <tr class="layout horizontal">
              <td><div id="corner" class=""></div></td>
              <td>
                <div id="columnHeader" class="columns">
                  <table class="inner">
                    <colgroup>
                      <col>
                      <template is="dom-repeat" items="{{gridColumns}}" as="column">
                        <col name="{{column.name}}" hidden="{{column.hidden}}">
                      </template>
                    </colgroup>
                    <thead>
                    <tr class="layout horizontal">
                      <template is="dom-repeat" items="{{gridColumns}}" as="column">
                        <!--<template is="dom-if" if="{{!column.hidden}}">-->
                        <th class="" hidden="{{column.hidden}}">
                          <div class="innerDiv">{{column.name}}</div>
                          <!--<iron-icon icon="editor:border-right"></iron-icon>-->
                        </th>
                        <!--</template>-->
                      </template>
                    </tr>
                    </thead>
                  </table>
                </div>
              </td>
            </tr>
            <tr class="layout horizontal">
              <td><div id="corner" class="style-scope my-grid"></div></td>
              <!--<td>-->
                <!--<div id="rowHeader" class="rows">-->
                  <!--&lt;!&ndash;<table class="inner">&ndash;&gt;-->
                    <!--&lt;!&ndash;<template is="dom-repeat" items="{{gridData}}" as="row">&ndash;&gt;-->
                      <!--&lt;!&ndash;<tr>&ndash;&gt;-->
                        <!--&lt;!&ndash;<template is="dom-repeat" items="{{gridColumns}}" as="column">&ndash;&gt;-->
                          <!--&lt;!&ndash;<template is="dom-if" if="{{!column.hidden}} && {{column.frozen}}">&ndash;&gt;-->
                            <!--&lt;!&ndash;<td class=""><div class="innerDiv">{{_computeCellData(column, row)}}</div></td>&ndash;&gt;-->
                          <!--&lt;!&ndash;</template>&ndash;&gt;-->
                        <!--&lt;!&ndash;</template>&ndash;&gt;-->
                      <!--&lt;!&ndash;</tr>&ndash;&gt;-->
                    <!--&lt;!&ndash;</template>&ndash;&gt;-->
                  <!--&lt;!&ndash;</table>&ndash;&gt;-->
                <!--</div>-->
              <!--</td>-->
              <td>
                <div id="data" class="data">
                  <table class="inner" >
                    <colgroup>
                      <col>
                      <template is="dom-repeat" items="{{gridColumns}}" as="column">
                        <col name="{{column.name}}" hidden="{{column.hidden}}">
                      </template>
                    </colgroup>
                    <tbody>
                    <template is="dom-repeat" items="{{gridData}}" as="row">
                      <tr>
                        <template is="dom-repeat" items="{{gridColumns}}" as="column">
                          <!--<template is="dom-if" if="{{!column.hidden}} && {{!column.frozen}}">-->
                            <td class="" hidden="{{column.hidden}}"><div class="innerDiv">{{_computeCellData(column, row)}}</div></td>
                          </template>
                        <!--</template>-->
                      </tr>
                    </template>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div id="columnState">
          <columns-dropdown grid-columns="{{gridColumns}}"></columns-dropdown>
        </div>
      </div>

    </div>
  </template>
  <script>

      Polymer({
        is: 'my-grid',

        properties: {
          gridData: Array,

          gridColumns: {
            type: Array,
            notify: true
          }


    },

        listeners: {
          'refresh': '_refreshGrid',
          'grid-columns-changed': '_columnsChanged',
          'grid-data-changed': '_itemsChanged',
          'column-changed': '_columnChanged'
        },

        created: function (e) {
          console.log(this.localName + ' was created!')
        },

        ready: function (e) {
          console.log(this.localName + ' was ready!');
        },

        attached: function () {
          console.log(this.localName + ' was attached!');
        },

        detached: function () {

        },

        _columnsChanged_: function (e) {
          console.log(this.localName + ' columnsChanged fired!');
        },

        _columnsChanged: function (e) {
          console.log(this.localName + ' columnsChanged fired!');
          var vaadin_grid = this.querySelector('vaadin-grid');
          if (!vaadin_grid)
            return;
          for(var i = 0; i < this.gridColumns.length; i++)
          {
            var renderFunction = this.gridColumns[i].renderer == undefined ? function(cell) { cell.element.innerHTML = (cell.data == null ? '' : cell.data ); } : this.gridColumns[i].renderer;
            vaadin_grid.columns[i] = { "name": this.gridColumns[i].propertyName, "hidable": this.gridColumns[i].hidable, "hidden": this.gridColumns[i].hidden, "sortable": this.gridColumns[i].sortable, renderer: renderFunction };
          }

          vaadin_grid.then(function () {
            var vaadin_grid = document.querySelector("vaadin-grid");
            var grid = document.querySelector("my-grid");
            if (vaadin_grid == undefined || grid == undefined || grid == null || grid.gridColumns == null)
              return;
            for(var i = 0; i < grid.gridColumns.length; i++) {
              console.log('Header-Cell 0,'+ i + ': ' , vaadin_grid.header.getCell(0, i));
              vaadin_grid.header.getCell(0, i).content = grid.gridColumns[i].name;
            }
            //vaadin_grid.frozenColumns = 2;
          });
        },

        _itemsChanged: function (e) {
          var grid = document.querySelector("my-grid");
          grid.toggleClass('grid-loading-data', false, document.querySelector("#grid-container"));
        },

        _refreshGrid: function(){
          console.log(this.localName + ' refresh!');
          var grid = document.querySelector("vaadin-grid");
          if (grid == undefined)
            return;
          this.toggleClass('grid-loading-data', true, document.querySelector("#grid-container"));
          grid.gridData = [{}];
//          this.fire('loadData-' + this.getAttribute('id'), { 'grid' : grid });
        },

        _dataLoaded: function() {
          grid.gridData = this.gridData == undefined ? [] : this.gridData;
        },

        updateItems: function () {
          var grid = document.querySelector("vaadin-grid");
          grid.gridData = [{}];

//          var loadingIndicatorRow = document.getElementById('loadingIndicatorRow');
//          loadingIndicatorRow.setAttribute("class", "show");
//                      grid.items = function(params, callback) {
//                        getJSON('https://demo.vaadin.com/demo-data/1.0/people?index=' + params.index + '&count=' + params.count, function(json) {
//                          callback(json.result, json.size);
//                        });
//                      };
        },

        _computeCellData: function(column, row) {
           return column.renderer(column, row);
        },

        _columnChanged: function (e, detail) {
          console.log(this.localName + '_columnChanged fired!', e, detail);
          this.fire('update-column', detail);
        }
      });

  </script>
</dom-module>
